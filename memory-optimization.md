# 后端内存优化分析报告

## 发现的问题

### 1. **Base64图片存储导致内存爆炸** ⚠️ 高风险
- **问题**：avatar_url以base64字符串存储在数据库中
- **风险**：
  - body-parser limit: 10mb，意味着单个请求可能包含10mb的base64字符串
  - Base64编码会增加约33%的大小
  - 如果5个用户，每人上传10mb图片 = 50mb
  - 如果每个用户有100个联系人，每个联系人10mb图片 = **5GB+**
  - 每次查询都会加载所有avatar_url到内存

### 2. **数据库查询无分页** ⚠️ 中风险
- **问题**：所有GET请求都没有LIMIT/OFFSET
- **风险**：
  - `/api/thoughts` - 可能返回数千条想法
  - `/api/contacts` - 可能返回数百个联系人（每个包含base64图片）
  - `/api/tasks` - 可能返回大量任务
  - 一次性加载所有数据到内存

### 3. **SQLite verbose模式** ⚠️ 低风险
- **问题**：`db.js`中启用了`verbose: console.log`
- **风险**：所有SQL查询都会记录，可能占用内存

### 4. **没有请求大小验证** ⚠️ 中风险
- **问题**：虽然body-parser有10mb限制，但没有对avatar_url字段大小进行验证
- **风险**：恶意用户可能上传接近10mb的base64字符串

### 5. **数据库文件不断增长** ⚠️ 低风险
- **问题**：SQLite删除数据后不会立即释放空间
- **风险**：数据库文件会不断增长，占用磁盘空间

## 优化建议

### 优先级1：限制Base64图片大小
- 在存储前验证base64字符串大小（建议限制为500KB base64 = ~375KB原图）
- 或者改用文件存储系统（推荐）

### 优先级2：添加分页支持
- 为所有列表查询添加LIMIT/OFFSET
- 默认每页20-50条记录

### 优先级3：关闭SQLite verbose模式
- 生产环境关闭verbose日志

### 优先级4：添加请求验证
- 验证avatar_url字段大小
- 添加请求频率限制

### 优先级5：定期清理数据库
- 添加VACUUM机制
